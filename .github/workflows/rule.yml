name: Manage Branch Lock

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch name to lock/unlock'
        required: true
        default: 'main'
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - lock
          - unlock

jobs:
  manage-lock:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Lock Branch
        if: inputs.action == 'lock'
        run: |
          curl -X PUT \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/branches/${{ inputs.branch }}/protection/lock_branch \
            -d '{"enabled":true}'
          
          if [ $? -eq 0 ]; then
            echo "✅ Branch '${{ inputs.branch }}' locked successfully"
          else
            echo "❌ Failed to lock branch '${{ inputs.branch }}'"
            exit 1
          fi

      - name: Unlock Branch
        if: inputs.action == 'unlock'
        run: |
          curl -X DELETE \
            -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/branches/${{ inputs.branch }}/protection/lock_branch
          
          if [ $? -eq 0 ]; then
            echo "✅ Branch '${{ inputs.branch }}' unlocked successfully"
          else
            echo "❌ Failed to unlock branch '${{ inputs.branch }}'"
            exit 1
          fi

      - name: Verify Lock Status
        run: |
          response=$(curl -s \
            -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/branches/${{ inputs.branch }}/protection)
          
          echo "Current protection status:"
          echo "$response" | jq '.'
