name: Toggle main branch lock

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Choose enable to lock the branch, disable to unlock/remove protection.'
        required: true
        type: choice
        options:
          - enable
          - disable
      branch:
        description: 'Branch name to toggle (default: main)'
        required: true
        default: 'main'
        type: string
      unlock_only:
        description: 'If disabling, set true to only unlock (keep other protections), false to delete protection entirely.'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: write
  administration: write

jobs:
  toggle-lock:
    runs-on: ubuntu-latest
    steps:
      - name: Enable lock_branch on branch
        if: ${{ github.event.inputs.action == 'enable' }}
        run: |
          set -euo pipefail
          echo "Enabling lock_branch protection on '${{ github.event.inputs.branch }}' branch"
          curl -L -X PUT \
            -H "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/branches/${{ github.event.inputs.branch }}/protection \
            -d @- <<'EOF'
          {
            "required_status_checks": null,
            "enforce_admins": false,
            "required_pull_request_reviews": null,
            "restrictions": null,
            "required_linear_history": false,
            "allow_force_pushes": false,
            "allow_deletions": false,
            "block_creations": false,
            "lock_branch": true
          }
          EOF

      - name: Disable (delete entire protection)
        if: ${{ github.event.inputs.action == 'disable' && github.event.inputs.unlock_only == 'false' }}
        run: |
          set -euo pipefail
          echo "Deleting branch protection on '${{ github.event.inputs.branch }}' (including lock)"
          curl -L -X DELETE \
            -H "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/branches/${{ github.event.inputs.branch }}/protection

      - name: Disable (just unlock, keep other config)
        if: ${{ github.event.inputs.action == 'disable' && github.event.inputs.unlock_only == 'true' }}
        run: |
          set -euo pipefail
          echo "Unlocking '${{ github.event.inputs.branch }}' branch but keeping other (minimal) protection config"
          curl -L -X PUT \
            -H "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/branches/${{ github.event.inputs.branch }}/protection \
            -d @- <<'EOF'
          {
            "required_status_checks": null,
            "enforce_admins": false,
            "required_pull_request_reviews": null,
            "restrictions": null,
            "required_linear_history": false,
            "allow_force_pushes": false,
            "allow_deletions": false,
            "block_creations": false,
            "lock_branch": false
          }
          EOF

      - name: Verify result
        run: |
          set -euo pipefail
          echo "Fetching current protection settings for '${{ github.event.inputs.branch }}':"
          curl -L -X GET \
            -H "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/branches/${{ github.event.inputs.branch }}/protection || echo 'No protection currently set.'

# Notes:
# - This workflow assumes the GitHub API supports the lock_branch field on branch protection.
#   If your repository uses Rulesets instead, adjust to use the /repos/{owner}/{repo}/rulesets endpoints.
# - The PAT_TOKEN must have administration: write permission (granted above) to modify protections.
# - Trigger manually via Actions > Toggle main branch lock > Run workflow. Provide branch name (default main).
